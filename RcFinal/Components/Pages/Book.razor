@page "/book"
@layout HotelLayout
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using RcFinal.Models
@using System.Security.Claims
@inject ReservasService ReservasService
@inject AuthenticationStateProvider AuthStateProvider
@inject IToastService toastService
@inject NavigationManager Nav

<PageTitle>Book</PageTitle>

<div class="booking-form">
    <h3>Booking Your Hotel</h3>
    <EditForm Model="reserva" OnValidSubmit="HandleValidSubmit" FormName="ReservaForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="check-date">
            <label for="date-in">Check In:</label>
            <InputDate @bind-Value="reserva.CheckIn" id="date-in" class="form-control" />
        </div>

        <div class="check-date">
            <label for="date-out">Check Out:</label>
            <InputDate @bind-Value="reserva.CheckOut" id="date-out" class="form-control" />
        </div>

        <div class="select-option mb-3">
            <label for="guest">Guests:</label>
            <InputNumber @bind-Value="reserva.Guests"
                         id="guest"
                         class="form-control"
                         min="1"
                         max="5" />
            <ValidationMessage For="@(() => reserva.Guests)" />
        </div>

        <div class="mb-3">
            <label for="package">Package:</label>
            <InputSelect @bind-Value="reserva.PackageId" class="form-control">
                @foreach (var pkg in packages)
                {
                    <option value="@pkg.PackageId">@pkg.Name (@pkg.PricePerNightPerGuest € / night / guest)</option>
                }
            </InputSelect>

            <ValidationMessage For="@(() => reserva.PackageId)" />
        </div>

        <button type="submit" class="btn btn-primary">Book now</button>
    </EditForm>
</div>

@code {
    private string? errorMessage;
    private List<Package> packages = new();
    private List<Quartos> rooms = new();
    private int selectedRoomId = -1;

    [SupplyParameterFromForm]
    private Reservas reserva { get; set; } = new()
        {
            CheckIn = DateTime.Today,
            CheckOut = DateTime.Today.AddDays(1),
            Guests = 1,
            PackageId = "1"
        };

    protected override async Task OnInitializedAsync()
    {
        rooms = (await ReservasService.GetQuartosAsync()).ToList();
        packages = (await ReservasService.GetPackagesAsync()).ToList();

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            reserva.Email = user.FindFirst(ClaimTypes.Email)?.Value
                           ?? user.Identity.Name
                           ?? throw new InvalidOperationException("Authenticated user has no email claim.");
        }
    }

    private async Task AutoAssignRoom()
    {
        var candidates = rooms
            .Where(r => r.Capacidade == reserva.Guests)
            .OrderBy(r => r.Capacidade);

        foreach (var room in candidates)
        {
            var test = new Reservas
                {
                    CheckIn = reserva.CheckIn,
                    CheckOut = reserva.CheckOut,
                    Guests = reserva.Guests,
                    RoomId = room.RoomId,
                    Email = reserva.Email
                };

            if (!await ReservasService.HasOverlapAsync(test))
            {
                selectedRoomId = room.RoomId;
                return;
            }
        }
    }

    private async Task HandleValidSubmit()
    {
        await AutoAssignRoom();
        // 1. Enforce at least one night:
        if (reserva.CheckOut <= reserva.CheckIn)
        {
            errorMessage = "Check-out must be at least one day after check-in.";
            toastService.ShowWarning(errorMessage);
            return;
        }

        // 2. Now try to auto-assign a room
        await AutoAssignRoom();
        if (selectedRoomId == -1)
        {
            errorMessage = "No rooms available.";
            toastService.ShowError(errorMessage);
            return;
        }

        // 3. Package selected?
        if (string.IsNullOrWhiteSpace(reserva.PackageId))
        {
            errorMessage = "Please select a package.";
            toastService.ShowWarning(errorMessage);
            return;
        }

        var selectedPackage = packages.FirstOrDefault(p => p.PackageId == reserva.PackageId);
        if (selectedPackage == null)
        {
            errorMessage = "Invalid package selected.";
            toastService.ShowWarning(errorMessage);
            return;
        }

        var nights = (reserva.CheckOut - reserva.CheckIn).Days;
        reserva.RoomId = selectedRoomId;
        reserva.TotalCost = selectedPackage.PricePerNightPerGuest
                            * reserva.Guests
                            * nights;

        var newReservaId = await ReservasService.SaveReserva(reserva);
        var costEntry = new ReservationCost
            {
                ReservaId = newReservaId,
                Cost = reserva.TotalCost,
                RecordedAt = DateTime.UtcNow
            };
        await ReservasService.SaveReservationCost(costEntry);

        Nav.NavigateTo("/?bookingSuccess=true");
    }
}